# ==========================
# ===  General Settings  ===
# ==========================

set-option -g default-terminal "screen-256color"
set-option -g history-limit 20000
set-option -g buffer-limit 20
set-option -sg escape-time 0
set-option -g display-time 1500
set-option -g remain-on-exit off
set-option -g repeat-time 300
set-option -g visual-activity on

set-window-option -g monitor-activity on
set-window-option -g xterm-keys on
set-window-option -g aggressive-resize on

# Set parent terminal title to reflect current window in tmux session
set-option -g set-titles on
set-option -g set-titles-string '#W:#T'

# Start index of window/pane with 1
set-option -g base-index 1
set-window-option -g pane-base-index 1

# =====================
# ===  Keybindings  ===
# =====================

# Change prefix key to C-\ to avoid emacs conflicts
unbind C-b
set-option -g prefix 'C-\'
bind-key 'C-\' send-prefix

# Unbind keys we're going to reassign
unbind '"' # split-window
unbind %   # split-window -h
unbind }   # swap-pane -D
unbind {   # swap-pane -U
unbind [   # paste-buffer
unbind ]
unbind n   # next-window
unbind p   # previous-window
unbind l   # last-window
unbind M-n # next window with alert
unbind M-p # previous window with alert
unbind o   # focus thru panes
unbind &   # kill-window
unbind '$' # rename-session

# Change window splitting to | and - for horizontal and vertical splits
bind-key | split-window -h -c "#{pane_current_path}"
bind-key - split-window -v -c "#{pane_current_path}"

# Add a binding to reload the configuration
bind-key C-r source-file "$XDG_CONFIG_HOME/tmux/tmux-legacy.conf" \; display-message "Reloaded '$XDG_CONFIG_HOME/tmux/tmux-legacy.conf"

# Create a new window with the current cwd
bind-key c new-window -c "#{pane_current_path}"

# Pane and window navigation
bind -r C-o swap-pane -D
bind -r C-[ previous-window
bind -r C-] next-window
bind -r [ select-pane -t :.-
bind -r ] select-pane -t :.+

# Link window
bind L command-prompt -p "Link window from (session:window): " "link-window -s %% -a"

# Kill windows/panes
bind x kill-pane
bind X kill-window
bind C-x confirm-before -p "kill other windows? (y/n)" "kill-window -a"
bind Q confirm-before -p "kill-session #S? (y/n)" kill-session

# Session detach
bind d detach
bind D if 'test -z "#{session_many_attached}"' \
    'confirm-before -p "Detach other clients? (y/n)" "detach -a"' \
    'display "Session has only 1 client attached"'

# Hide status bar on demand
bind C-s if 'test -z "#{s/off//:status}"' 'set status off' 'set status on'

# Window monitoring/silence
bind m set-window-option monitor-activity \; display-message 'Monitor window activity [#{?monitor-activity,ON,OFF}]'
bind M if 'test -z "#{monitor-slience}"' \
    'set-window-option monitor-slience 0 ; display-message "Monitor window silence [OFF]"' \
    'command-prompt -p "Monitor silence: interval (s)" "set-window-option monitor-silence %%"'

# Paste
bind p paste-buffer
bind C-p choose-buffer

# =======================
# ==  Color Variables  ==
# =======================

color_orange="colour208"
color_purple="colour135"
color_green="colour76"
color_blue="colour39"
color_yellow="colour220"
color_red="colour160"
color_black="colour232"
color_white="colour15"
color_grey="colour240"

# ========================
# == Special Characters ==
# ========================

powerline_left=""
powerline_right=""
powerline_connection="⧫"

# ====================
# ==  Theme Colors  ==
# ====================

color_primary="$color_blue"
color_secondary="$color_green"
color_tertiary="$color_purple"
color_dark="$color_grey"
color_light="$color_white"

color_level_ok="$color_green"
color_level_warn="$color_yellow"
color_level_stress="$color_red"

color_session_bg="$color_primary"
color_session_fg="$color_black"

color_user_bg="$color_secondary"
color_user_fg="$color_black"

color_pane_bg="$color_white"
color_pane_fg="$color_black"

color_time_bg="$color_white"
color_time_fg="$color_black"

color_date_bg="$color_primary"
color_date_fg="$color_black"

color_host_bg="$color_tertiary"
color_host_fg="$color_black"

color_status_bg="$color_dark"
color_status_fg="default"

color_window_bg="$color_blue"
color_window_fg="$color_black"

color_current_window_bg="$color_purple"
color_current_window_fg="$color_black"

color_keys_off_bg="$color_red"
color_keys_off_fg="$color_light"

color_message_bg="$color_primary"
color_message_fg="$color_black"

color_mode_bg="$color_secondary"
color_mode_fg="$color_black"

# ===================
# == Theme Formats ==
# ===================

window_format=" #I:#W "

# ====================
# == Status Widgets ==
# ====================

wg_session="#[fg=$color_session_fg,bg=$color_session_bg,bold] #S #[default]"
wg_user="#[fg=$color_user_fg,bg=$color_user_bg] #(whoami) #[default]"
wg_pane="#[fg=$color_pane_fg,bg=$color_pane_bg] #I:#P #[default]"

wg_time="#[fg=$color_time_fg,bg=$color_time_bg] %H:%M:%S #[default]"
wg_date="#[fg=$color_date_fg,bg=$color_date_bg] %Y-%m-%d #[default]"
wg_host="#[fg=$color_host_fg,bg=$color_host_bg,bold] #H #[default]"

wg_is_zoomed="#[fg=$color_dark,bg=$color_secondary]#{?window_zoomed_flag,[Z],}#[default]"
wg_battery="#{battery_color_charge_fg} #{battery_icon} #{battery_percentage}"

# ==================
# ==  Appearance  ==
# ==================

set -g mode-bg "$color_mode_bg"
set -g mode-fg "$color_mode_fg"

set -g message-bg "$color_message_bg"
set -g message-fg "$color_message_fg"

set -g status on
set -g status-interval 5
set -g status-position top
set -g status-justify centre
set -g status-left-length 40
set -g status-right-length 150
set -g status-bg "$color_status_bg"
set -g status-fg "$color_status_fg"

# Status Left: Session > User > Window:Pane
set -g status-left "${wg_session}#[fg=$color_session_bg,bg=$color_user_bg]${powerline_left}${wg_user}#[fg=$color_user_bg,bg=$color_pane_bg]${powerline_left}${wg_pane}#[fg=$color_pane_bg]${powerline_left}"

# Status Right: Time < Date < Host
set -g status-right "${wg_is_zoomed} #[fg=$color_time_bg]${powerline_right}${wg_time}#[fg=$color_date_bg,bg=$color_time_bg]${powerline_right}${wg_date}#[fg=$color_host_bg,bg=$color_date_bg]${powerline_right}${wg_host}"

# Window Status
set -g window-status-separator " "
set -g window-status-format "$window_format"
set -g window-status-bg "$color_window_bg"
set -g window-status-fg "$color_window_fg"

set -g window-status-current-format "$window_format"
set -g window-status-current-bg "$color_current_window_bg"
set -g window-status-current-fg "$color_current_window_fg"
set -g window-status-activity-bg "$color_current_window_bg"
set -g window-status-activity-fg "$color_current_window_fg"

# Pane Border Handles
set -g pane-border-fg "$color_light"
set -g pane-active-border-fg "$color_primary"

if-shell 'test -n "$SSH_CLIENT"' \
    'source-file $XDG_CONFIG_HOME/tmux/remote-legacy.conf'
